#!/usr/bin/env bash

set -o errexit
set -o pipefail
#set -o xtrace

: ${AWS_DEFAULT_REGION:=$(aws configure get region || echo ap-northeast-1)}
export AWS_DEFAULT_REGION

: ${CODECOMMIT_HOST:=git-codecommit.$AWS_DEFAULT_REGION.amazonaws.com}

repos=`aws codecommit list-repositories | jq -r '.repositories | map(.repositoryName) | join("\n")'`
filter=$1

for repo in $repos; do
  # Test repo name with filter
  [[ $repo = $filter* ]] || continue
  # _ is the separator in repo name
  dir=${repo//_/\/}
  [ ! -d "$dir" ] && git clone --recursive "$CODECOMMIT_HOST":/v1/repos/$repo $dir
done
