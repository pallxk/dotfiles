#!/usr/bin/env bash

set -euo pipefail

OTP_DIR=${OTP_DIR:-~/.config/otp}

prefix=
if [ $# -ge 1 ]; then
  prefix=${1}
  shift
elif [ ! -t 0 ]; then
  prefix=$(cat /dev/stdin)
fi

# Print all names if no prefix provided
if [ -z "$prefix" ]; then
  jq --null-input --raw-output --exit-status \
    "[ inputs[] ] | map( del(.secret) ) | sort_by(.name)" \
    "$OTP_DIR"/*.json
  exit
fi

# Get the OTP object for the selected prefix
otp=$(jq --null-input --raw-output --exit-status \
  "[ inputs[] ] | map(select( .name|startswith(\"$prefix\") )) | .[0]" \
  "$OTP_DIR"/*.json
)

secret=$(jq -r .secret <<< "$otp")
digits=$(jq -r ".digits // 6" <<< "$otp")
period=$(jq -r ".period // 30" <<< "$otp")

# Calc OTP
otp=$(echo "$secret" | oathtool --totp --base32 --digits="$digits" --time-step-size="$period"s "$@" -)

if [ -t 1 ]; then
  # Output and copy OTP if running interactively
  echo "$otp" | tee >(base64 | xargs printf "\e]52;c;%s\a")
else
  # Otherwise output OTP only
  echo "$otp"
fi
