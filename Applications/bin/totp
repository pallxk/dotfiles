#!/usr/bin/env bash

set -euo pipefail

TOTP_DIR=${TOTP_DIR:-~/.config/totp}
prefix=${1-}

# Print all names if no prefix provided
if [ -z "$prefix" ]; then
  jq --null-input --raw-output --exit-status \
    "[ inputs[] ] | map( del(.secret) ) | sort_by(.name)" \
    "$TOTP_DIR"/*.json
  exit
fi

# Print the TOTP code for the selected prefix
secret=$(jq --null-input --raw-output --exit-status \
  "[ inputs[] ] | map(select( .name|startswith(\"$prefix\") )) | .[0].secret" \
  "$TOTP_DIR"/*.json
)

echo "$secret" | oathtool --totp --base32 -
