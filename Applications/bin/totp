#!/usr/bin/env bash

set -euo pipefail

TOTP_DIR=${TOTP_DIR:-~/.config/totp}

prefix=
if [ $# -ge 1 ]; then
  prefix=${1}
  shift
fi

# Print all names if no prefix provided
if [ -z "$prefix" ]; then
  jq --null-input --raw-output --exit-status \
    "[ inputs[] ] | map( del(.secret) ) | sort_by(.name)" \
    "$TOTP_DIR"/*.json
  exit
fi

# Get the TOTP object for the selected prefix
totp=$(jq --null-input --raw-output --exit-status \
  "[ inputs[] ] | map(select( .name|startswith(\"$prefix\") )) | .[0]" \
  "$TOTP_DIR"/*.json
)

secret=$(jq -r .secret <<< "$totp")
digits=$(jq -r ".digits // 6" <<< "$totp")
period=$(jq -r ".period // 30" <<< "$totp")

# Calc OTP, output and copy it
echo "$secret" \
  | oathtool --totp --base32 --digits="$digits" --time-step-size="$period"s "$@" - \
  | tee >(base64 | xargs printf "\e]52;c;%s\a")
